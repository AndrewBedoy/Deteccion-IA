<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detector de Calidad - AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #eef2f3, #cfd9df);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      color: #1f2937;
      font-size: 2rem;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .button {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .button:hover {
      transform: scale(1.05);
      background: linear-gradient(to right, #2563eb, #1e40af);
    }

    select {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      background-color: white;
      min-width: 200px;
    }

    #webcam-container canvas {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #label-container {
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
    }

    .label {
      background-color: #ffffff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .label-text {
      font-weight: 600;
      margin-bottom: 6px;
      color: #1f2937;
    }

    .bar-container {
      background-color: #e5e7eb;
      height: 16px;
      border-radius: 10px;
      overflow: hidden;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #10b981, #22c55e);
      transition: width 0.4s ease;
    }

    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <h1>Detector de Calidad AI</h1>

  <div class="controls">
    <select id="modelSelect">
      <option value="https://teachablemachine.withgoogle.com/models/T4AwZ052t/">Modelo base</option>
    </select>

    <button class="button" onclick="init()">Iniciar</button>
    <button class="button" onclick="stop()">Detener</button>
    <button class="button" onclick="switchCamera()">Cambiar Cámara</button>
  </div>

  <div id="webcam-container"></div>
  <div id="label-container"></div>

  

<script>
    let model, webcam, labelContainer, maxPredictions;
    let currentModelURL = "";
    let cameras = [];
    let currentCameraIndex = 0;
    let loopId;

    async function init() {
      await stop();

      // Enumeramos dispositivos si aún no lo hicimos
      if (cameras.length === 0) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(device => device.kind === "videoinput");

        if (cameras.length === 0) {
          alert("No se encontraron cámaras");
          return;
        }

        // Intentar encontrar la trasera primero
        const backCam = cameras.find(cam => cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("rear") || cam.label.toLowerCase().includes("environment"));
        if (backCam) {
          currentCameraIndex = cameras.indexOf(backCam);
        } else {
          currentCameraIndex = 0;
        }
      }

      currentModelURL = document.getElementById("modelSelect").value;
      const modelURL = currentModelURL + "model.json";
      const metadataURL = currentModelURL + "metadata.json";

      try {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const deviceId = cameras[currentCameraIndex].deviceId;
        webcam = new tmImage.Webcam(400, 400, false, { deviceId });

        await webcam.setup();
        await webcam.play();

        document.getElementById("webcam-container").innerHTML = "";
        document.getElementById("webcam-container").appendChild(webcam.canvas);

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";

        for (let i = 0; i < maxPredictions; i++) {
          const labelDiv = document.createElement("div");
          labelDiv.className = "label";

          const labelText = document.createElement("div");
          labelText.className = "label-text";
          labelText.innerText = "Clase";

          const barContainer = document.createElement("div");
          barContainer.className = "bar-container";

          const bar = document.createElement("div");
          bar.className = "bar";

          barContainer.appendChild(bar);
          labelDiv.appendChild(labelText);
          labelDiv.appendChild(barContainer);
          labelContainer.appendChild(labelDiv);
        }

        loop();
      } catch (e) {
        alert("Error: " + e.message);
        console.error(e);
      }
    }

    async function switchCamera() {
      if (cameras.length <= 1) {
        alert("Solo hay una cámara disponible");
        return;
      }

      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      await init();
    }

    async function stop() {
      if (webcam) {
        await webcam.stop();
        cancelAnimationFrame(loopId);
        document.getElementById("webcam-container").innerHTML = "";
        document.getElementById("label-container").innerHTML = "";
        webcam = null;
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      loopId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      const labelElements = document.getElementById("label-container").children;

      for (let i = 0; i < maxPredictions; i++) {
        const className = prediction[i].className;
        const prob = (prediction[i].probability * 100).toFixed(1);
        const labelDiv = labelElements[i];
        labelDiv.querySelector(".label-text").innerText = `${className}: ${prob}%`;
        labelDiv.querySelector(".bar").style.width = `${prob}%`;
      }
    }
  </script>

</body>
</html>
